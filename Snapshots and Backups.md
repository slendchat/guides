# Как работают Снэпшоты

Есть отличие архитектуры хранения файлов
плокская таблица - FAT, ntfs( гораздо сложнее просто на базе таблицы)
древовидная архитектура - ext4, btrfs и т.д.

В древе возможны снэпшоты (без дополнений)
данные хранятся в сбалансированном древе где есть корень, ключи и листья.
Каждое дерево обслуживает:
- иноды,
- имена файлов (dir tree),
- указатели на блоки (extent tree),
- данные (в листьях),
- снэпшоты (отдельные корни).

Допустим у нас есть упрощенное B-tree
```less
[Root Node]
 ├── [Internal Node A]
 │    ├── [Leaf Node A1] → содержит: FileA → [Block#1204]
 │    └── [Leaf Node A2] → FileB → [Block#1301]
 └── [Internal Node B]
      ├── [Leaf Node B1] → FileC → [Block#1402]
```

Три файла ссылаются на блоки разные блоки. 
Когда происходит снэпшот эта таблица записывается и сохраняется как еще один корень.
Далее изза того что сделан снэпшот, каждому блоку ссылка на который есть в снэпшоте добавляется `refcount+=1`  

Когда в основной ФС (древе), происходит изменение файла, например блока `[Block#1204]`
он не меняется напрямую така его `refcount>1 //true`. Выделяется блок из свободного пространство, в него копируется содержимое блока `[Block#1204]` + изменения и изменяется структура основного рут древа на то чтобы `FileA` ссылался на новый блок. В то время как старый не удаляется и не используется для записи так как он используется в снэпшоте. Когда произойдет откат до снэпшота, то `refcount-=1` и древо из снэпшота заменит основное рут древо, данные остались без изменений, а файлы снова указывают на эти блоки данных. 

Абстрактное представление работы снэпшотов.
![[snapshots.gif]]


https://habr.com/ru/companies/netapp/articles/112367/

